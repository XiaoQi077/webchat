{% extends "base.html" %}

{% block title %}èŠå¤© - WebèŠå¤©å®¤{% endblock %}

{% block content %}
<div class="chat-container">
    <div class="user-list-sidebar">
        <div class="sidebar-header">
            <h3>åœ¨çº¿ç”¨æˆ· ({{ online_user_ids|length }})</h3>
        </div>

        <div class="search-box">
            <input type="text" placeholder="æœç´¢ç”¨æˆ·æˆ–ç¾¤ç»„...">
        </div>

        <div class="user-list">
            <div class="user-category">èŠå¤©</div>
            <div class="user-item active" data-chat-type="public" onclick="selectPublicChatHandler()">
                <span class="status-indicator online"></span>
                <img src="{{ url_for('static', filename='images/public_chat.png') }}" class="user-avatar" alt="å…¬å…±èŠå¤©å®¤">
                <div class="user-info">
                    <div class="user-name">å…¬å…±èŠå¤©å®¤</div>
                </div>
            </div>

            <div class="user-category">ç”¨æˆ·</div>
            {% for user in users %}
                {% if user.id != current_user.id %}
                    <div class="user-item {% if user.id in online_user_ids %}online{% else %}offline{% endif %}"
                         data-user-id="{{ user.id }}"
                         onclick="selectUserHandler({{ user.id }}, '{{ user.nickname or user.username }}')">
                        <span class="status-indicator {% if user.id in online_user_ids %}online{% else %}offline{% endif %}"></span>
                        <img src="{{ user.avatar or url_for('static', filename='images/default_avatar.png') }}" class="user-avatar" alt="{{ user.nickname or user.username }}">
                        <div class="user-info">
                            <div class="user-name">{{ user.nickname or user.username }}</div>
                            <div class="user-status">{% if user.id in online_user_ids %}åœ¨çº¿{% else %}ç¦»çº¿{% endif %}</div>
                        </div>
                    </div>
                {% endif %}
            {% endfor %}

            <div class="user-category">æˆ‘çš„ç¾¤ç»„</div>
            {% for group in user_groups %}
                <div class="user-item" data-group-id="{{ group.id }}" onclick="selectGroupHandler({{ group.id }}, '{{ group.name }}')">
                    <span class="status-indicator online"></span>
                    <img src="{{ url_for('static', filename='images/group_chat.png') }}" class="user-avatar" alt="{{ group.name }}">
                    <div class="user-info">
                        <div class="user-name">{{ group.name }}</div>
                        <div class="user-status">ç¾¤ç»„</div>
                    </div>
                </div>
            {% endfor %}

            <div class="user-category">æ‰€æœ‰ç¾¤ç»„</div>
            {% for group in groups %}
                <div class="user-item" data-group-id="{{ group.id }}" onclick="selectGroupHandler({{ group.id }}, '{{ group.name }}')">
                    <span class="status-indicator online"></span>
                    <img src="{{ url_for('static', filename='images/group_chat.png') }}" class="user-avatar" alt="{{ group.name }}">
                    <div class="user-info">
                        <div class="user-name">{{ group.name }}</div>
                        <div class="user-status">åˆ›å»ºè€…: {{ group.creator_name }}</div>
                    </div>
                </div>
            {% endfor %}
        </div>

        {% if current_user.can_create_group %}
        <div class="create-group-section">
            <button onclick="document.getElementById('create-group-modal').style.display='block'">åˆ›å»ºç¾¤ç»„</button>
        </div>
        {% endif %}
    </div>

    <div class="chat-area">
        <div class="chat-header">
            <div class="chat-title" id="chat-header">å…¬å…±èŠå¤©å®¤</div>
            <div class="chat-actions">
                <button title="åˆ·æ–°èŠå¤©è®°å½•" onclick="loadHistoryMessages()">â†»</button>
                <button title="æ¸…é™¤èŠå¤©è®°å½•" onclick="document.getElementById('messages-container').innerHTML=''">Ã—</button>
            </div>
        </div>

        <div class="messages-container" id="messages-container"></div>

        <div class="message-input-area">
            <div class="message-input-tools">
                <button title="å‘é€å›¾ç‰‡">ğŸ“·</button>
                <button title="å‘é€æ–‡ä»¶">ğŸ“</button>
                <button title="è¡¨æƒ…">ğŸ˜Š</button>
            </div>

            <div class="message-input">
                <input type="text" id="message-input" placeholder="è¾“å…¥æ¶ˆæ¯..." {% if not current_user.can_public_chat %}disabled{% endif %}>
            </div>

            <div class="message-send">
                <button id="send-button" {% if not current_user.can_public_chat %}disabled{% endif %}>å‘é€</button>
            </div>
        </div>
    </div>
</div>

<!-- åˆ›å»ºç¾¤ç»„æ¨¡æ€æ¡† -->
<div id="create-group-modal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="document.getElementById('create-group-modal').style.display='none'">&times;</span>
        <h2>åˆ›å»ºç¾¤ç»„</h2>
        <form id="create-group-form">
            <div class="form-group">
                <label for="group-name">ç¾¤ç»„åç§°</label>
                <input type="text" id="group-name" name="group_name" required>
            </div>
            <button type="submit">åˆ›å»º</button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/chat.js') }}"></script>
<script>
    // å…¨å±€å˜é‡
    const current_user_can_public_chat = {{ 'true' if current_user.can_public_chat else 'false' }};
    const current_user_can_private_chat = {{ 'true' if current_user.can_private_chat else 'false' }};

    // å…¨å±€å‡½æ•°ä¾›HTMLè°ƒç”¨
    function selectUserHandler(userId, userName) {
        if (typeof selectUser === 'function') {
            selectUser(userId, userName);
        }
    }

    function selectPublicChatHandler() {
        if (typeof selectPublicChat === 'function') {
            selectPublicChat();
        }
    }

    function selectGroupHandler(groupId, groupName) {
        if (typeof selectGroup === 'function') {
            selectGroup(groupId, groupName);
        }
    }

    // æ¨¡æ€æ¡†åŠŸèƒ½
    window.onclick = function(event) {
        const modal = document.getElementById('create-group-modal');
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }
</script>
{% endblock %}